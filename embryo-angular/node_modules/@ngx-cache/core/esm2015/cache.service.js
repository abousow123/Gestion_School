import { Inject, Injectable, InjectionToken, Injector, PLATFORM_ID } from '@angular/core';
import { CacheLoader } from './cache.loader';
import { ReturnType } from './models/return-type';
import * as i0 from "@angular/core";
import * as i1 from "./cache.loader";
export const CACHE = new InjectionToken('CACHE');
export class CacheService {
    constructor(loader, platformId, injector) {
        this.loader = loader;
        this.platformId = platformId;
        this.injector = injector;
        CacheService.instance = this;
        this.cache = this.injector.get(CACHE);
        this.lifeSpan = loader.lifeSpan;
    }
    static getInstance(loader, platformId, injector) {
        return CacheService.instance;
    }
    static normalizeKey(key) {
        if (CacheService.validateKey(key)) {
            throw new Error('Please provide a valid key to save in the CacheService');
        }
        return `${key}`;
    }
    static validateKey(key) {
        return !key || typeof key === 'boolean' || Number.isNaN(key);
    }
    static validateValue(value) {
        return value.lifeSpan.expiry && value.lifeSpan.expiry > Date.now();
    }
    get key() {
        return this.loader.key;
    }
    has(key) {
        const normalized = CacheService.normalizeKey(key);
        return this.cache.keys.indexOf(normalized) !== -1 && CacheService.validateValue(this.cache.getItem(normalized));
    }
    set(key, value, returnType = ReturnType.Scalar, lifeSpan) {
        const normalized = CacheService.normalizeKey(key);
        return this.cache.setItem(normalized, {
            data: value,
            returnType,
            lifeSpan: this.parseLifeSpan(lifeSpan ? lifeSpan : this.lifeSpan)
        });
    }
    get(key) {
        const normalized = CacheService.normalizeKey(key);
        const cached = this.cache.getItem(normalized);
        if (Object.entries(cached).length !== 0 && cached.constructor === Object) {
            if (CacheService.validateValue(cached)) {
                return cached.data;
            }
            this.remove(normalized);
        }
        return undefined;
    }
    getWithMetadata(key) {
        const normalized = CacheService.normalizeKey(key);
        const cached = this.cache.getItem(normalized);
        if (Object.entries(cached).length !== 0 && cached.constructor === Object) {
            if (CacheService.validateValue(cached)) {
                return cached;
            }
            this.remove(key);
        }
        return undefined;
    }
    remove(key, wild = false) {
        const normalized = CacheService.normalizeKey(key);
        this.cache.removeItem(normalized, wild);
    }
    clear() {
        this.cache.clear();
    }
    dehydrate() {
        const keys = this.cache.keys.length ? this.cache.keys : [];
        const res = {};
        keys.forEach((key) => {
            res[key] = this.cache.getItem(key);
        });
        return res;
    }
    rehydrate(json) {
        Object.keys(json).forEach((key) => {
            const normalized = CacheService.normalizeKey(key);
            this.cache.setItem(normalized, json[normalized]);
        });
    }
    parseLifeSpan(lifeSpan) {
        return {
            expiry: lifeSpan.expiry || (lifeSpan.TTL ? Date.now() + lifeSpan.TTL * 1000 : this.lifeSpan.expiry),
            TTL: lifeSpan.TTL || this.lifeSpan.TTL
        };
    }
}
CacheService.instance = undefined;
CacheService.ɵfac = function CacheService_Factory(t) { return new (t || CacheService)(i0.ɵɵinject(i1.CacheLoader), i0.ɵɵinject(PLATFORM_ID), i0.ɵɵinject(i0.Injector)); };
CacheService.ɵprov = i0.ɵɵdefineInjectable({ token: CacheService, factory: CacheService.ɵfac });
(function () { i0.ɵsetClassMetadata(CacheService, [{
        type: Injectable
    }], function () { return [{ type: i1.CacheLoader }, { type: undefined, decorators: [{
                type: Inject,
                args: [PLATFORM_ID]
            }] }, { type: i0.Injector }]; }, null); })();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2FjaGUuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BuZ3gtY2FjaGUvY29yZS8iLCJzb3VyY2VzIjpbImNhY2hlLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLE1BQU0sRUFBRSxVQUFVLEVBQUUsY0FBYyxFQUFFLFFBQVEsRUFBRSxXQUFXLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFHMUYsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBRzdDLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxzQkFBc0IsQ0FBQzs7O0FBRWxELE1BQU0sQ0FBQyxNQUFNLEtBQUssR0FBRyxJQUFJLGNBQWMsQ0FBUSxPQUFPLENBQUMsQ0FBQztBQUd4RCxNQUFNLE9BQU8sWUFBWTtJQTBCdkIsWUFBcUIsTUFBbUIsRUFBd0MsVUFBZSxFQUFtQixRQUFrQjtRQUEvRyxXQUFNLEdBQU4sTUFBTSxDQUFhO1FBQXdDLGVBQVUsR0FBVixVQUFVLENBQUs7UUFBbUIsYUFBUSxHQUFSLFFBQVEsQ0FBVTtRQUNsSSxZQUFZLENBQUMsUUFBUSxHQUFHLElBQUksQ0FBQztRQUU3QixJQUFJLENBQUMsS0FBSyxHQUFHLElBQUksQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBQ3RDLElBQUksQ0FBQyxRQUFRLEdBQUcsTUFBTSxDQUFDLFFBQVEsQ0FBQztJQUNsQyxDQUFDO0lBekJELE1BQU0sQ0FBQyxXQUFXLENBQUMsTUFBb0IsRUFBRSxVQUFnQixFQUFFLFFBQW1CO1FBQzVFLE9BQU8sWUFBWSxDQUFDLFFBQVEsQ0FBQztJQUMvQixDQUFDO0lBRUQsTUFBTSxDQUFDLFlBQVksQ0FBQyxHQUFvQjtRQUN0QyxJQUFJLFlBQVksQ0FBQyxXQUFXLENBQUMsR0FBRyxDQUFDLEVBQUU7WUFDakMsTUFBTSxJQUFJLEtBQUssQ0FBQyx3REFBd0QsQ0FBQyxDQUFDO1NBQzNFO1FBRUQsT0FBTyxHQUFH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QUksQ0FBQyxRQUFRLENBQUMsTUFBTSxDQUFDO1lBQ25HLEdBQUcsRUFBRSxRQUFRLENBQUMsR0FBRyxJQUFJLElBQUksQ0FBQyxRQUFRLENBQUMsR0FBRztTQUN2QyxDQUFDO0lBQ0osQ0FBQzs7QUFuSGMscUJBQVEsR0FBaUIsU0FBUyxDQUFDO3dFQUR2QyxZQUFZLDJDQTBCMkIsV0FBVztvREExQmxELFlBQVksV0FBWixZQUFZO29DQUFaLFlBQVk7Y0FEeEIsVUFBVTs7c0JBMkJrQyxNQUFNO3VCQUFDLFdBQVciLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3QsIEluamVjdGFibGUsIEluamVjdGlvblRva2VuLCBJbmplY3RvciwgUExBVEZPUk1fSUQgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcblxuaW1wb3J0IHsgQ2FjaGUgfSBmcm9tICcuL2NhY2hlJztcbmltcG9ydCB7IENhY2hlTG9hZGVyIH0gZnJvbSAnLi9jYWNoZS5sb2FkZXInO1xuaW1wb3J0IHsgQ2FjaGVWYWx1ZSB9IGZyb20gJy4vbW9kZWxzL2NhY2hlLXZhbHVlJztcbmltcG9ydCB7IExpZmVTcGFuIH0gZnJvbSAnLi9tb2RlbHMvbGlmZS1zcGFuJztcbmltcG9ydCB7IFJldHVyblR5cGUgfSBmcm9tICcuL21vZGVscy9yZXR1cm4tdHlwZSc7XG5cbmV4cG9ydCBjb25zdCBDQUNIRSA9IG5ldyBJbmplY3Rpb25Ub2tlbjxDYWNoZT4oJ0NBQ0hFJyk7XG5cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBDYWNoZVNlcnZpY2Uge1xuICBwcml2YXRlIHN0YXRpYyBpbnN0YW5jZTogQ2FjaGVTZXJ2aWNlID0gdW5kZWZpbmVkO1xuXG4gIHByb3RlY3RlZCByZWFkb25seSBjYWNoZTogQ2FjaGU7XG4gIHByb3RlY3RlZCByZWFkb25seSBsaWZlU3BhbjogTGlmZVNwYW47XG5cbiAgc3RhdGljIGdldEluc3RhbmNlKGxvYWRlcj86IENhY2hlTG9hZGVyLCBwbGF0Zm9ybUlkPzogYW55LCBpbmplY3Rvcj86IEluamVjdG9yKTogQ2FjaGVTZXJ2aWNlIHtcbiAgICByZXR1cm4gQ2FjaGVTZXJ2aWNlLmluc3RhbmNlO1xuICB9XG5cbiAgc3RhdGljIG5vcm1hbGl6ZUtleShrZXk6IHN0cmluZyB8IG51bWJlcik6IHN0cmluZyB7XG4gICAgaWYgKENhY2hlU2VydmljZS52YWxpZGF0ZUtleShrZXkpKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ1BsZWFzZSBwcm92aWRlIGEgdmFsaWQga2V5IHRvIHNhdmUgaW4gdGhlIENhY2hlU2VydmljZScpO1xuICAgIH1cblxuICAgIHJldHVybiBgJHtrZXl9YDtcbiAgfVxuXG4gIHByaXZhdGUgc3RhdGljIHZhbGlkYXRlS2V5KGtleTogc3RyaW5nIHwgbnVtYmVyKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuICFrZXkgfHwgdHlwZW9mIGtleSA9PT0gJ2Jvb2xlYW4nIHx8IE51bWJlci5pc05hTihrZXkgYXMgbnVtYmVyKTtcbiAgfVxuXG4gIHByaXZhdGUgc3RhdGljIHZhbGlkYXRlVmFsdWUodmFsdWU6IENhY2hlVmFsdWUpOiBib29sZWFuIHtcbiAgICByZXR1cm4gdmFsdWUubGlmZVNwYW4uZXhwaXJ5ICYmIHZhbHVlLmxpZmVTcGFuLmV4cGlyeSA+IERhdGUubm93KCk7XG4gIH1cblxuICBjb25zdHJ1Y3RvcihyZWFkb25seSBsb2FkZXI6IENhY2hlTG9hZGVyLCBASW5qZWN0KFBMQVRGT1JNX0lEKSBwcml2YXRlIHJlYWRvbmx5IHBsYXRmb3JtSWQ6IGFueSwgcHJpdmF0ZSByZWFkb25seSBpbmplY3RvcjogSW5qZWN0b3IpIHtcbiAgICBDYWNoZVNlcnZpY2UuaW5zdGFuY2UgPSB0aGlzO1xuXG4gICAgdGhpcy5jYWNoZSA9IHRoaXMuaW5qZWN0b3IuZ2V0KENBQ0hFKTtcbiAgICB0aGlzLmxpZmVTcGFuID0gbG9hZGVyLmxpZmVTcGFuO1xuICB9XG5cbiAgZ2V0IGtleSgpOiBzdHJpbmcge1xuICAgIHJldHVybiB0aGlzLmxvYWRlci5rZXk7XG4gIH1cblxuICBoYXMoa2V5OiBzdHJpbmcgfCBudW1iZXIpOiBib29sZWFuIHtcbiAgICBjb25zdCBub3JtYWxpemVkID0gQ2FjaGVTZXJ2aWNlLm5vcm1hbGl6ZUtleShrZXkpO1xuXG4gICAgcmV0dXJuIHRoaXMuY2FjaGUua2V5cy5pbmRleE9mKG5vcm1hbGl6ZWQpICE9PSAtMSAmJiBDYWNoZVNlcnZpY2UudmFsaWRhdGVWYWx1ZSh0aGlzLmNhY2hlLmdldEl0ZW0obm9ybWFsaXplZCkpO1xuICB9XG5cbiAgc2V0KGtleTogc3RyaW5nIHwgbnVtYmVyLCB2YWx1ZTogYW55LCByZXR1cm5UeXBlOiBSZXR1cm5UeXBlID0gUmV0dXJuVHlwZS5TY2FsYXIsIGxpZmVTcGFuPzogTGlmZVNwYW4pOiBib29sZWFuIHtcbiAgICBjb25zdCBub3JtYWxpemVkID0gQ2FjaGVTZXJ2aWNlLm5vcm1hbGl6ZUtleShrZXkpO1xuXG4gICAgcmV0dXJuIHRoaXMuY2FjaGUuc2V0SXRlbShub3JtYWxpemVkLCB7XG4gICAgICBkYXRhOiB2YWx1ZSxcbiAgICAgIHJldHVyblR5cGUsXG4gICAgICBsaWZlU3BhbjogdGhpcy5wYXJzZUxpZmVTcGFuKGxpZmVTcGFuID8gbGlmZVNwYW4gOiB0aGlzLmxpZmVTcGFuKVxuICAgIH0pO1xuICB9XG5cbiAgZ2V0KGtleTogc3RyaW5nIHwgbnVtYmVyKTogYW55IHtcbiAgICBjb25zdCBub3JtYWxpemVkID0gQ2FjaGVTZXJ2aWNlLm5vcm1hbGl6ZUtleShrZXkpO1xuICAgIGNvbnN0IGNhY2hlZCA9IHRoaXMuY2FjaGUuZ2V0SXRlbShub3JtYWxpemVkKTtcblxuICAgIGlmIChPYmplY3QuZW50cmllcyhjYWNoZWQpLmxlbmd0aCAhPT0gMCAmJiBjYWNoZWQuY29uc3RydWN0b3IgPT09IE9iamVjdCkge1xuICAgICAgaWYgKENhY2hlU2VydmljZS52YWxpZGF0ZVZhbHVlKGNhY2hlZCkpIHtcbiAgICAgICAgcmV0dXJuIGNhY2hlZC5kYXRhO1xuICAgICAgfVxuXG4gICAgICB0aGlzLnJlbW92ZShub3JtYWxpemVkKTtcbiAgICB9XG5cbiAgICByZXR1cm4gdW5kZWZpbmVkO1xuICB9XG5cbiAgZ2V0V2l0aE1ldGFkYXRhKGtleTogc3RyaW5nIHwgbnVtYmVyKTogQ2FjaGVWYWx1ZSB8IHVuZGVmaW5lZCB7XG4gICAgY29uc3Qgbm9ybWFsaXplZCA9IENhY2hlU2VydmljZS5ub3JtYWxpemVLZXkoa2V5KTtcbiAgICBjb25zdCBjYWNoZWQgPSB0aGlzLmNhY2hlLmdldEl0ZW0obm9ybWFsaXplZCk7XG5cbiAgICBpZiAoT2JqZWN0LmVudHJpZXMoY2FjaGVkKS5sZW5ndGggIT09IDAgJiYgY2FjaGVkLmNvbnN0cnVjdG9yID09PSBPYmplY3QpIHtcbiAgICAgIGlmIChDYWNoZVNlcnZpY2UudmFsaWRhdGVWYWx1ZShjYWNoZWQpKSB7XG4gICAgICAgIHJldHVybiBjYWNoZWQ7XG4gICAgICB9XG5cbiAgICAgIHRoaXMucmVtb3ZlKGtleSk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgfVxuXG4gIHJlbW92ZShrZXk6IHN0cmluZyB8IG51bWJlciwgd2lsZCA9IGZhbHNlKTogdm9pZCB7XG4gICAgY29uc3Qgbm9ybWFsaXplZCA9IENhY2hlU2VydmljZS5ub3JtYWxpemVLZXkoa2V5KTtcblxuICAgIHRoaXMuY2FjaGUucmVtb3ZlSXRlbShub3JtYWxpemVkLCB3aWxkKTtcbiAgfVxuXG4gIGNsZWFyKCk6IHZvaWQge1xuICAgIHRoaXMuY2FjaGUuY2xlYXIoKTtcbiAgfVxuXG4gIGRlaHlkcmF0ZSgpOiBhbnkge1xuICAgIGNvbnN0IGtleXMgPSB0aGlzLmNhY2hlLmtleXMubGVuZ3RoID8gdGhpcy5jYWNoZS5rZXlzIDogW107XG4gICAgY29uc3QgcmVzID0ge307XG5cbiAgICBrZXlzLmZvckVhY2goKGtleTogc3RyaW5nKSA9PiB7XG4gICAgICByZXNba2V5XSA9IHRoaXMuY2FjaGUuZ2V0SXRlbShrZXkpO1xuICAgIH0pO1xuXG4gICAgcmV0dXJuIHJlcztcbiAgfVxuXG4gIHJlaHlkcmF0ZShqc29uOiBhbnkpOiB2b2lkIHtcbiAgICBPYmplY3Qua2V5cyhqc29uKS5mb3JFYWNoKChrZXk6IHN0cmluZykgPT4ge1xuICAgICAgY29uc3Qgbm9ybWFsaXplZCA9IENhY2hlU2VydmljZS5ub3JtYWxpemVLZXkoa2V5KTtcbiAgICAgIHRoaXMuY2FjaGUuc2V0SXRlbShub3JtYWxpemVkLCBqc29uW25vcm1hbGl6ZWRdKTtcbiAgICB9KTtcbiAgfVxuXG4gIHByaXZhdGUgcGFyc2VMaWZlU3BhbihsaWZlU3BhbjogTGlmZVNwYW4pOiBMaWZlU3BhbiB7XG4gICAgcmV0dXJuIHtcbiAgICAgIGV4cGlyeTogbGlmZVNwYW4uZXhwaXJ5IHx8IChsaWZlU3Bhbi5UVEwgPyBEYXRlLm5vdygpICsgbGlmZVNwYW4uVFRMICogMTAwMCA6IHRoaXMubGlmZVNwYW4uZXhwaXJ5KSxcbiAgICAgIFRUTDogbGlmZVNwYW4uVFRMIHx8IHRoaXMubGlmZVNwYW4uVFRMXG4gICAgfTtcbiAgfVxufVxuIl19